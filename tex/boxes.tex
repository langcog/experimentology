\usepackage{tcolorbox}
\tcbuselibrary{skins} % allow changing skin
\tcbuselibrary{breakable} % allow breaking across pages

% colors (solarized) (must be in cmyk)
\definecolor{.yellow}{cmyk}{0,.24,1,.29}
\definecolor{.orange}{cmyk}{0,.63,.89,.20}
\definecolor{.red}{cmyk}{0,.77,.79,.14}
\definecolor{.magenta}{cmyk}{0,.74,.38,.17}
\definecolor{.violet}{cmyk}{.45,.42,0,.23}
\definecolor{.blue}{cmyk}{.82,.34,0,.18}
\definecolor{.cyan}{cmyk}{7.4,0,.06,.37}
\definecolor{.green}{cmyk}{.13,0,1,.40}
\definecolor{.base0}{cmyk}{.13,.01,0,.41}

% icons (not using fontawesome5 package because some needed icons are from 6)
\usepackage{fontspec}
\newfontfamily{\fa}[Path=resources/fontawesome/webfonts/]{fa-solid-900.ttf}
\def\faAppleWhole{{\fa \symbol{"F5D1}}}
\def\faMicroscope{{\fa \symbol{"F610}}}
\def\faLeaf{{\fa \symbol{"F06C}}}
\def\faPersonFallingBurst{{\fa \symbol{"E547}}}
\def\faCode{{\fa \symbol{"F121}}}
\def\faMagnifyingGlassPlus{{\fa \symbol{"F00E}}}
\def\faPenRuler{{\fa \symbol{"F5AE}}}
\def\faComments{{\fa \symbol{"F086}}}
\def\faBook{{\fa \symbol{"F02D}}}

% set options for all boxes
\def\pagewidth{\marginparsep+\marginparsep+1pt}
\tcbset{enhanced jigsaw,                          % skin
        breakable,                                % break across pages
        boxrule=2pt,                              % border width
        colback=white,                            % background color
        fonttitle=\sffamily\scshape\LARGE,        % title sans and small caps
        left=2mm, right=2mm, %bottom=2mm, top=2mm, % padding inside box
        toptitle=1mm, bottomtitle=1mm,            % spacing above/below title
        grow to right by=\pagewidth,              % fullwidth
        % show bounding box,
        before upper={\parskip6pt                 % format settings within box
                      \setlist[itemize]{leftmargin=*,label={--}}
                      \setlist[enumerate]{leftmargin=*}}}
                      % \titlespacing{\subsection}{0pt}{\parskip}{-\parskip}}}

% define box for each type (color, icon, title)
\newtcolorbox{learning_goals}{%
  grow to right by=-\marginparwidth-\marginparsep, % non-fullwidth
  colframe=.red,
  title=\faAppleWhole \enspace Learning goals}
\newtcolorbox{case_study}{%
  colframe=.blue,
  title=\faMicroscope \enspace Case study}
\newtcolorbox{ethical_considerations}{%
  colframe=.green,
  title=\faLeaf \enspace Ethical considerations}
\newtcolorbox{accident_report}{%
  colframe=.orange,
  title=\faPersonFallingBurst \enspace Accident report}
\newtcolorbox{code}{%
  colframe=.base0,
  title=\faCode \enspace Code}
\newtcolorbox{depth}{%
  colframe=.violet,
  title=\faMagnifyingGlassPlus \enspace Depth}
\newtcolorbox{exercises}{%
  colframe=.yellow,
  title=\faPenRuler \enspace Exercises}
\newtcolorbox{discussion_questions}{%
  colframe=.cyan,
  title=\faComments \enspace Discussion questions}
\newtcolorbox{readings}{%
  colframe=.magenta,
  title=\faBook \enspace Readings}

% define within-box title as subsection
% \newcommand{\boxtitle}[1]{\subsection*{#1}\vspace{-12pt}}
% \titlespacing{\boxtitle}{0pt}{\parskip}{-\parskip}

% define box for figures within boxes
\usepackage{caption}
\newtcolorbox[blend into=figures]{boxfigure}[1][]{%
  size=minimal,
  colback=white,
  % boxrule=0pt,
  #1}

% define box for references
\newtcolorbox{refsbox}{%
  size=minimal,                 % no padding space, no box rules
  before upper={\footnotesize}} % smaller font inside

% redefine CSLReferences to wrap in refsbox
\renewenvironment{CSLReferences}[2] % #1 hanging-ident, #2 entry spacing
 {% don't indent paragraphs
 \begin{refsbox}
  \setlength{\parindent}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1
  \let\oldpar\par
  \def\par{\hangindent=\cslhangindent\oldpar}
  \fi
  % set entry spacing
  \setlength{\parskip}{#2\cslentryspacingunit}
 }%
 {\end{refsbox}}
 